<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manager Dashboard | RestaurantJobs Kenya</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <nav class="container">
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="/" class="nav-brand" style="text-decoration: none; color: #333;">Restaurant<span
                    style="color: var(--accent-color);">Jobs</span> <span
                    style="font-size: 0.9rem; color: #666; font-weight: 400; margin-left: 5px;">Admin</span></a>
        </div>

        <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="Toggle Menu">&#9776;</button>

        <div id="nav-links" class="nav-links">
            <span style="font-weight: 600;">Hello, Admin</span>
            <button id="logout-btn" class="btn-secondary"
                style="border: 1px solid var(--accent-color); color: var(--accent-color);">Logout</button>
        </div>
    </nav>

    <main class="container" style="padding: 40px 20px;">

        <!-- Stats Overview -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <div class="card" style="text-align: center; padding: 25px;">
                <h2 style="font-size: 2.5rem; color: var(--accent-color); margin-bottom: 5px;" id="stat-apps">0</h2>
                <p style="color: #666; font-size: 0.9rem; font-weight: 600; text-transform: uppercase;">Total
                    Applications</p>
            </div>
            <div class="card" style="text-align: center; padding: 25px;">
                <h2 style="font-size: 2.5rem; color: #2ecc71; margin-bottom: 5px;" id="stat-hiring">0</h2>
                <p style="color: #666; font-size: 0.9rem; font-weight: 600; text-transform: uppercase;">Hiring
                    Requests</p>
            </div>
            <div class="card" style="text-align: center; padding: 25px;">
                <h2 style="font-size: 2.5rem; color: #3498db; margin-bottom: 5px;" id="stat-jobs">0</h2>
                <p style="color: #666; font-size: 0.9rem; font-weight: 600; text-transform: uppercase;">Active Jobs
                </p>
            </div>
        </div>

        <h1 style="margin-bottom: 20px;">Admin Actions</h1>

        <!-- Post Job Section -->
        <div class="card" style="margin-bottom: 40px; padding: 30px;">
            <h2 style="margin-bottom: 20px;">Post a Job Directly</h2>
            <form id="admin-post-job-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Job Title</label>
                        <input type="text" name="title" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Location</label>
                        <input type="text" name="location" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Job Type</label>
                        <select name="type"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option>Full-time</option>
                            <option>Part-time</option>
                            <option>Contract</option>
                            <option>Casual</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description</label>
                    <textarea name="description" rows="4" required
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                </div>
                <button type="submit" class="btn" id="post-btn">Post Job to Feed</button>
            </form>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin-bottom: 0;">Received Applications</h1>
            <input type="text" id="app-filter" placeholder="Filter by Name or Job..."
                style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 250px;">
        </div>

        <div style="overflow-x: auto; margin-bottom: 60px;">
            <table
                style="width: 100%; border-collapse: collapse; min-width: 600px; background: white; border-radius: var(--radius-sm); overflow: hidden; box-shadow: var(--shadow-sm);">
                <thead style="background-color: var(--bg-color); border-bottom: 2px solid var(--border-color);">
                    <tr>
                        <th style="padding: 15px; text-align: left;">Date</th>
                        <th style="padding: 15px; text-align: left;">Name</th>
                        <th style="padding: 15px; text-align: left;">Position</th>
                        <th style="padding: 15px; text-align: left;">Email</th>
                        <th style="padding: 15px; text-align: left;">Resume</th>
                    </tr>
                </thead>
                <tbody id="app-table-body">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>

        <h1 style="margin-bottom: 40px;">Agency Hiring Requests</h1>
        <div style="overflow-x: auto;">
            <table
                style="width: 100%; border-collapse: collapse; min-width: 600px; background: white; border-radius: var(--radius-sm); overflow: hidden; box-shadow: var(--shadow-sm);">
                <thead style="background-color: var(--bg-color); border-bottom: 2px solid var(--border-color);">
                    <tr>
                        <th style="padding: 15px; text-align: left;">Date</th>
                        <th style="padding: 15px; text-align: left;">Employer ID</th>
                        <th style="padding: 15px; text-align: left;">Job Title</th>
                        <th style="padding: 15px; text-align: left;">Status</th>
                        <th style="padding: 15px; text-align: left;">Actions</th>
                    </tr>
                </thead>
                <tbody id="request-table-body">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>
        <h1 style="margin-bottom: 20px;">Job Posted History</h1>
        <div style="overflow-x: auto; margin-bottom: 60px;">
            <table
                style="width: 100%; border-collapse: collapse; min-width: 600px; background: white; border-radius: var(--radius-sm); overflow: hidden; box-shadow: var(--shadow-sm);">
                <thead style="background-color: var(--bg-color); border-bottom: 2px solid var(--border-color);">
                    <tr>
                        <th style="padding: 15px; text-align: left;">Date</th>
                        <th style="padding: 15px; text-align: left;">Title</th>
                        <th style="padding: 15px; text-align: left;">Location</th>
                        <th style="padding: 15px; text-align: left;">Status</th>
                        <th style="padding: 15px; text-align: left;">Actions</th>
                    </tr>
                </thead>
                <tbody id="job-table-body">
                    <!-- Jobs injected here -->
                </tbody>
            </table>
        </div>

        <p id="loading" style="margin-top: 20px;">Loading data...</p>
    </main>

    <script type="module" src="/src/ui.js"></script>
    <script type="module">
        import { supabase } from './src/supabaseClient.js';

        // Utility: Escape HTML to prevent XSS
        window.escapeHtml = function (text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function loadData() {
            try {
                // Load Applications
                // Note: RLS policies might restrict visibility unless logged in as specific user/admin
                const { data: apps, error: appError } = await supabase
                    .from('applications')
                    .select('*, jobs(title, employer_id)')
                    .order('created_at', { ascending: false });

                if (appError) throw appError;

                const appBody = document.getElementById('app-table-body');

                if (!apps || apps.length === 0) {
                    appBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center;">No applications yet.</td></tr>';
                } else {
                    const rows = apps.map(app => {
                        const jobTitle = app.jobs?.title || 'Unknown Job';
                        return `
                        <tr class="app-row" data-search="${escapeHtml(app.name).toLowerCase()} ${escapeHtml(jobTitle).toLowerCase()}" style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 15px;">${new Date(app.created_at).toLocaleDateString()}</td>
                            <td style="padding: 15px; font-weight: 600;">${escapeHtml(app.name)}</td>
                            <td style="padding: 15px;">
                                <div>${escapeHtml(app.position)}</div>
                                <small style="color: #666;">${escapeHtml(jobTitle)}</small>
                            </td>
                            <td style="padding: 15px;">${escapeHtml(app.email)}</td>
                            <td style="padding: 15px;">
                                ${app.resume_url ? `<a href="${app.resume_url.startsWith('http') ? app.resume_url : supabase.storage.from('resumes').getPublicUrl(app.resume_url).data.publicUrl}" target="_blank" style="color: var(--accent-color); text-decoration: underline;">View Resume</a>` : 'N/A'}
                            </td>
                        </tr>
                    `}).join('');

                    appBody.innerHTML = rows;

                    // Filter Logic
                    document.getElementById('app-filter').addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        const allRows = document.querySelectorAll('.app-row');
                        allRows.forEach(row => {
                            const searchData = row.getAttribute('data-search');
                            if (searchData.includes(term)) {
                                row.style.display = 'table-row';
                            } else {
                                row.style.display = 'none';
                            }
                        })
                    });
                }

                // Load Requests
                const { data: reqs, error: reqError } = await supabase
                    .from('hiring_requests')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (reqError) throw reqError;

                const reqBody = document.getElementById('request-table-body');

                if (!reqs || reqs.length === 0) {
                    reqBody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center;">No agency requests yet.</td></tr>';
                } else {
                    reqBody.innerHTML = reqs.map(req => `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 15px;">${new Date(req.created_at).toLocaleDateString()}</td>
                            <td style="padding: 15px;">${req.org_name || 'Employer ' + req.employer_id.substr(0, 4)}</td>
                            <td style="padding: 15px;">
                                <strong>${req.title}</strong><br>
                                <small>${req.type} | ${req.location}</small>
                            </td>
                            <td style="padding: 15px;">
                                <span style="background: ${req.status === 'approved' ? '#d4edda' : req.status === 'rejected' ? '#f8d7da' : '#fff3cd'}; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                                    ${req.status}
                                </span>
                            </td>
                            <td style="padding: 15px;">
                                ${req.status === 'pending_agency_review' || req.status === 'new_lead' ? `
                                    <button onclick="updateRequestStatus('${req.id}', 'approved', '${req.title}', '${req.location || ''}', '${req.type || ''}', '${req.description || ''}', '${req.employer_id}')" 
                                        style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Approve</button>
                                    <button onclick="updateRequestStatus('${req.id}', 'rejected')" 
                                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Reject</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `).join('');
                }

                document.getElementById('stat-apps').innerText = apps.length;
                document.getElementById('stat-hiring').innerText = reqs.length;
                // Load All Jobs (History)
                const { data: allJobs, error: jobError } = await supabase
                    .from('jobs')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (jobError) throw jobError;

                const jobBody = document.getElementById('job-table-body');
                if (!allJobs || allJobs.length === 0) {
                    jobBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center;">No active jobs found.</td></tr>';
                } else {
                    jobBody.innerHTML = allJobs.map(job => `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 15px;">${new Date(job.created_at).toLocaleDateString()}</td>
                            <td style="padding: 15px; font-weight: 600;">${job.title}</td>
                            <td style="padding: 15px;">${job.location}</td>
                             <td style="padding: 15px;"><span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">${job.status}</span></td>
                            <td style="padding: 15px;">
                                <button onclick="deleteJob('${job.id}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; text-decoration: underline;">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }

                document.getElementById('stat-jobs').innerText = allJobs ? allJobs.length : 0;

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('FULL ERROR:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: red; padding: 20px; background: #fff0f0; border-radius: 8px; text-align: left;">
                        <h3>Error Loading Data</h3>
                        <p><strong>Message:</strong> ${error.message}</p>
                        <p><strong>Hint:</strong> ${error.hint || 'No hint provided'}</p>
                        <p><strong>Details:</strong> ${error.details || 'Check console logs'}</p>
                    </div>
                `;
            }
        }

        // Admin Post Job Logic
        const postForm = document.getElementById('admin-post-job-form');
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('post-btn');
            const originalText = btn.innerText;
            btn.innerText = 'Posting...';
            btn.disabled = true;

            const formData = new FormData(postForm);
            const data = Object.fromEntries(formData.entries());

            try {
                // Ensure user is admin (RLS will enforce, but good to check context)
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('Not authenticated');

                const { error } = await supabase
                    .from('jobs')
                    .insert({
                        title: data.title,
                        location: data.location,
                        type: data.type,
                        description: data.description,
                        employer_id: user.id, // Admin is the 'employer' in this context
                        status: 'published',
                        source: 'admin'
                    });

                if (error) throw error;

                alert('Job posted successfully to the feed!');
                postForm.reset();

            } catch (err) {
                console.error(err);
                alert('Error posting job: ' + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // Admin Actions
        window.updateRequestStatus = async (id, status, title, location, type, description, employer_id) => {
            if (!confirm(`Are you sure you want to ${status} this request?`)) return;

            try {
                // 1. Update Request Status
                const { error: reqError } = await supabase
                    .from('hiring_requests')
                    .update({ status: status === 'approved' ? 'approved' : 'rejected' })
                    .eq('id', id);

                if (reqError) throw reqError;

                // 2. If Approved, Create a Job
                if (status === 'approved') {
                    const { error: jobError } = await supabase
                        .from('jobs')
                        .insert({
                            title, location, type, description, employer_id,
                            status: 'published',
                            source: 'agency_managed'
                        });
                    if (jobError) throw jobError;
                    alert('Request Approved & Job Published!');
                } else {
                    alert('Request Rejected.');
                }

                loadData(); // Refresh

            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            }
        };

        window.deleteJob = async (jobId) => {
            if (!confirm('Permanently delete this job?')) return;
            try {
                const { error } = await supabase.from('jobs').delete().eq('id', jobId);
                if (error) throw error;
                alert('Job deleted.');
                loadData();
            } catch (err) {
                console.error(err);
                alert('Error deleting job: ' + err.message);
            }
        };

        loadData();
    </script>
</body>

</html>